---
layout: post
title: "Suspend to disk"
date: 2014-01-04 13:21
comments: true
categories: ubuntu hibernate
---

В убунту криво работает suspend to disk, настроить его можно несколькими способами:
* стандартный ядерный -- у меня толком не заработал
* tuxonice -- работает отлично, но только если не зависнет во время засыпания при освобождении памяти. 
  Зависает когда много всего запущено. Например, очень часто виснет при запущенном броузере.
* uswsusp -- поставил только что. Навскидку работает более менее нормально, но:
  * проверку MD5 нужно отключить, иначе ругается на несовпадение контрольных сумм (тем не менее, при этом показывает одинаковые суммы)
  * шифрование образа не работает, т.к. [uswsusp не умеет работать с plymouth](https://bugs.launchpad.net/ubuntu/+source/uswsusp/+bug/736487)
  * сразу после просыпания комп усиленно работает диском и тормозит. Похоже, вытаскивает страницы памяти из свапа.
    Т.е. по ощущениям засыпание на диск становится не "более медленным и надежным засыпанием", а "выключением с полным сохранением сессии".

Буду рад советам как это все исправить.

Как включать hibernate в меню и как настраивать tuxonice я уже не помню, запишу для uswsusp, чтобы не забыть.

* Ставим `uswsusp`.
* Правим `/etc/uswsusp.conf`. Это также можно сделать и при помощи `dpkg-reconfigure uswsusp`, но вручную по-моему удобнее.
* Создаем `/etc/initramfs-tools/conf.d/resume`, в котором пишем `RESUME=/dev/sda1`. Здесь sda1 -- диск со свапом. Это нужно для срабатывания просыпания при загрузке.
* Каждый раз при изменении этих файлов запускаем `sudo update-initramfs -u`. Без этого изменения останутся у нас на диске и не попадут в initrd.
* Строчку в `/etc/grub/default` добавлять НЕ надо. Это понадобилось бы, если бы мы не пользовались initramfs-tools.
* Создаем `/etc/pm/config.d/00sleep_module` с содержимым `SLEEP_MODULE="uswsusp"`. Это нужно, чтобы использовался `uswsusp` при вызовах `pm-hibernate`.
* У нас теперь должно заработать засыпание при помощи команды `sudo s2disk`
